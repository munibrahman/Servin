# /* Copyright (C) Voltic Labs, Inc - All Rights Reserved
#  * Unauthorized copying of this file, via any medium is strictly prohibited
#  * Proprietary and confidential
#  */

AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31

Description: >
  Voltic Labs Stripe Stack

Parameters:
  ReleaseEnvironment:
    Type: String
    Default: dev
    Description: The software development environment (ie dev, testing, production, etc...)

  StripeSecretKey:
    Description: Secret key used for the stripe API
    Type: String

  StripeEndpointSecret:
    Description: Secret value of the endpoint, this value is generated by stripe
    Type: String

  StripeLambdaLayer:
    Description: Arn of Lambda layer that encompasses Stripe npm packages
    Type: String
  
  GraphQLApiId:
    Description: Unique AWS AppSync GraphQL API Identifier
    Type: String

  DynamoDBStripeTableName:
    Description: Name of the dynamodb table that holds stripe usernames corelating to each account/customer id
    Type: String


Outputs:

  DynamoDBStripeTableName:
    Description: Name of the table used to store user's uuids and stripe customer/account ids
    Value: !GetAtt StripeDynamoDBTable.Outputs.TableName

  ApiGatewayInvokeURL:
    Value: !GetAtt WebhookStack.Outputs.ApiGatewayInvokeURL


  # S3BucketName:
  #   Description: Resource name of the s3 bucket
  #   Value: !GetAtt S3Stack.Outputs.S3BucketName


Resources:

  StripeDynamoDBTable:
    Type: "AWS::CloudFormation::Stack"
    Properties:
      Parameters:
        TableName: !Sub ${DynamoDBStripeTableName}
      # Tags:
      #   - Tag
      TemplateURL: "./DynamoDB/template.yaml"
      TimeoutInMinutes: 15

  AppsyncAPI:
    Type: AWS::CloudFormation::Stack
    Properties:
      Parameters:
        APIName: !Sub Stripe-API-${ReleaseEnvironment}
        ReleaseEnvironment: !Sub ${ReleaseEnvironment}
        # UserPoolID: !GetAtt CognitoStack.Outputs.UserPoolID            
        StripeLambdaLayer: !Sub ${StripeLambdaLayer}
        DynamoDBStripeTableName: !Sub ${DynamoDBStripeTableName}
        StripeSecretKey:        !Sub ${StripeSecretKey}
        GraphQLApiId: !Sub ${GraphQLApiId}
      # Tags:
      #   - Tag
      TemplateURL: "./AppSync/template.yaml"
      TimeoutInMinutes: 15


  WebhookStack:
    Type: AWS::CloudFormation::Stack
    Properties:
      # NotificationARNs:
      #   - String
      Parameters:
      #   CustomResourceLayer:  !GetAtt LambdaLayers.Outputs.CustomResourceLambdaLayer
      #   UtilitiesLayer:       !GetAtt LambdaLayers.Outputs.UtilitiesLambdaLayer
        StripeLambdaLayer:      !Sub ${StripeLambdaLayer}
        StripeSecretKey:        !Sub ${StripeSecretKey}
        StripeEndpointSecret:   !Sub ${StripeEndpointSecret}
      #   DynamoDBStripeTableName: !GetAtt StripeDynamoDBTable.Outputs.TableName
      # Tags:
      #   - Key: CognitoStackKey
      #     Value: CognitoStackValue
      TemplateURL: "./Webhook/template.yaml"
      TimeoutInMinutes: 15